@using System.Linq.Expressions
@using Microsoft.AspNetCore.Components.Forms
@using SummitUI
@inherits InputBase<DateOnly?>

<div class="@Class">
    <PopoverRoot @bind-Open="_isOpen">
        <PopoverTrigger @attributes="AdditionalAttributes"
                        class="@GetTriggerClass()"
                        type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 opacity-50">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            @if (CurrentValue.HasValue)
            {
                <span>@CurrentValue.Value.ToString("D")</span>
            }
            else
            {
                <span class="text-su-muted-foreground">Pick a date</span>
            }
        </PopoverTrigger>
        <PopoverPortal>
            <PopoverContent class="w-auto p-0 bg-su-card text-su-card-foreground border border-su-border rounded-md shadow-md outline-none" Align="Align.Start" SideOffset="4">
                <CalendarRoot Value="CurrentValue" ValueChanged="OnValueChanged" class="p-3" Context="ctx">
                    <CalendarHeader class="flex items-center justify-between pt-1 relative pb-4">
                        <CalendarPrevButton class="h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 flex items-center justify-center rounded-md border border-su-border hover:bg-su-accent" />
                        <CalendarHeading class="text-sm font-medium" />
                        <CalendarNextButton class="h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 flex items-center justify-center rounded-md border border-su-border hover:bg-su-accent" />
                    </CalendarHeader>
                    <CalendarGrid class="w-full border-collapse space-y-1">
                        <CalendarGridHead>
                            <CalendarGridRow class="flex">
                                @if (ctx.Weekdays != null)
                                {
                                    @for (int i = 0; i < ctx.Weekdays.Length; i++)
                                    {
                                        var idx = i;
                                        <CalendarHeadCell Abbreviation="@ctx.WeekdaysLong[idx]" class="text-su-muted-foreground rounded-md w-9 font-normal text-[0.8rem]">
                                            @ctx.Weekdays[idx]
                                        </CalendarHeadCell>
                                    }
                                }
                            </CalendarGridRow>
                        </CalendarGridHead>
                        <CalendarGridBody>
                             @if (ctx.CurrentMonth != null)
                             {
                                 @foreach (var week in ctx.CurrentMonth.Weeks)
                                 {
                                     <CalendarGridRow class="flex w-full mt-2">
                                         @foreach (var date in week)
                                         {
                                             <CalendarCell Date="@date" class="relative p-0 text-center text-sm focus-within:relative focus-within:z-20 [&:has([aria-selected])]:bg-su-accent [&:has([aria-selected].day-outside)]:bg-su-accent/50 [&:has([aria-selected].day-range-end)]:rounded-r-md">
                                                 <CalendarDay class="@DayClass" />
                                             </CalendarCell>
                                         }
                                     </CalendarGridRow>
                                 }
                             }
                        </CalendarGridBody>
                    </CalendarGrid>
                </CalendarRoot>
            </PopoverContent>
        </PopoverPortal>
    </PopoverRoot>
</div>

@code {
    private bool _isOpen;

    [Parameter] public string? Class { get; set; }

    private void OnValueChanged(DateOnly? newValue)
    {
        CurrentValue = newValue;
        _isOpen = false;
    }

    private string GetTriggerClass()
    {
        // Base classes
        var classes = "inline-flex h-10 w-[240px] items-center justify-start text-left font-normal rounded-md border bg-su-background px-3 py-2 text-sm ring-offset-su-background hover:bg-su-accent hover:text-su-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-su-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 transition-colors";

        // Validation state styling (InputBase.CssClass handles 'valid' and 'invalid')
        if (!string.IsNullOrEmpty(CssClass))
        {
            if (CssClass.Contains("invalid"))
            {
                classes += " border-su-destructive text-su-destructive focus-visible:ring-su-destructive";
            }
            else if (CssClass.Contains("valid")) // Optional: style valid state
            {
                 classes += " border-su-border"; // Default border
            }
             else
            {
                 classes += " border-su-border";
            }
        }
        else
        {
             classes += " border-su-border";
        }

        return classes;
    }

    protected override bool TryParseValueFromString(string? value, out DateOnly? result, out string? validationErrorMessage)
    {
        // Not implemented as this component doesn't accept string input directly
        result = null;
        validationErrorMessage = null;
        return true;
    }

    // Tailwind classes for the day button
    private string DayClass => "h-9 w-9 p-0 font-normal aria-selected:opacity-100 hover:bg-su-accent hover:text-su-accent-foreground focus:bg-su-accent focus:text-su-accent-foreground rounded-md transition-colors data-[today]:bg-su-accent data-[today]:text-su-accent-foreground data-[selected]:bg-su-primary data-[selected]:text-su-primary-foreground data-[selected]:hover:bg-su-primary data-[selected]:hover:text-su-primary-foreground data-[selected]:focus:bg-su-primary data-[selected]:focus:text-su-primary-foreground data-[outside-month]:text-su-muted-foreground data-[outside-month]:opacity-50 data-[disabled]:text-su-muted-foreground data-[disabled]:opacity-50";
}
