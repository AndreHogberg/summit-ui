@page "/tests/datepicker/edit-form"
@rendermode InteractiveWebAssembly
@using System.ComponentModel.DataAnnotations

@if (!RendererInfo.IsInteractive)
{
    <div data-testid="page-loading">Loading...</div>
}
else
{
<div data-testid="page-ready">
    <h1>DatePicker EditForm Tests</h1>
    
    <div class="test-section" data-testid="editform-section">
        <h2>Basic EditForm Integration</h2>
        <EditForm EditContext="_editContext" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            
            <div class="field-container">
                <label>Birth Date (Required)</label>
                <DatePickerRoot @bind-Value="_model.BirthDate" data-testid="editform-datepicker">
                    <DatePickerField @bind-Value="_model.BirthDate" Name="birthDate" Required="true" class="datepicker-field" data-testid="editform-field">
                        <DatePickerLabel class="sr-only">Birth Date</DatePickerLabel>
                        <DatePickerInput class="datepicker-segments" data-testid="editform-input" />
                        <DatePickerTrigger class="datepicker-trigger" data-testid="editform-trigger">
                            <span>Open</span>
                        </DatePickerTrigger>
                    </DatePickerField>
                    <DatePickerPortal>
                        <DatePickerContent class="datepicker-content" data-testid="editform-content">
                            <DatePickerCalendar @bind-Value="_model.BirthDate" Context="cal" data-testid="editform-calendar">
                                <DatePickerCalendarHeader class="calendar-header">
                                    <DatePickerCalendarPrevButton class="calendar-nav-button">Prev</DatePickerCalendarPrevButton>
                                    <DatePickerCalendarHeading class="calendar-heading" />
                                    <DatePickerCalendarNextButton class="calendar-nav-button">Next</DatePickerCalendarNextButton>
                                </DatePickerCalendarHeader>
                                <DatePickerCalendarGrid class="calendar-grid">
                                    <DatePickerCalendarGridHead>
                                        <DatePickerCalendarGridRow>
                                            @for (int i = 0; i < cal.Weekdays.Length; i++)
                                            {
                                                var idx = i;
                                                <DatePickerCalendarHeadCell Abbreviation="@cal.WeekdaysLong[idx]" class="calendar-head-cell">
                                                    @cal.Weekdays[idx]
                                                </DatePickerCalendarHeadCell>
                                            }
                                        </DatePickerCalendarGridRow>
                                    </DatePickerCalendarGridHead>
                                    <DatePickerCalendarGridBody>
                                        @foreach (var week in cal.CurrentMonth.Weeks)
                                        {
                                            <DatePickerCalendarGridRow>
                                                @foreach (var date in week)
                                                {
                                                    <DatePickerCalendarCell Date="@date" Context="cellCtx">
                                                        <DatePickerCalendarDay class="calendar-day" />
                                                    </DatePickerCalendarCell>
                                                }
                                            </DatePickerCalendarGridRow>
                                        }
                                    </DatePickerCalendarGridBody>
                                </DatePickerCalendarGrid>
                            </DatePickerCalendar>
                        </DatePickerContent>
                    </DatePickerPortal>
                </DatePickerRoot>
                <ValidationMessage For="() => _model.BirthDate" class="validation-error" data-testid="editform-validation" />
                <p data-testid="editform-value">Value: @(_model.BirthDate?.ToString("yyyy-MM-dd") ?? "None")</p>
            </div>

            <button type="submit" data-testid="editform-submit">Submit</button>
            
            @if (_submitted)
            {
                <p data-testid="editform-success" style="color: green;">Form submitted successfully!</p>
            }
        </EditForm>
    </div>

    <div class="test-section" data-testid="calendar-selection-section">
        <h2>Calendar Selection Updates Form</h2>
        <EditForm EditContext="_editContext2" OnValidSubmit="HandleValidSubmit2">
            <DataAnnotationsValidator />
            
            <div class="field-container">
                <label>Event Date (Required)</label>
                <DatePickerRoot @bind-Value="_model2.EventDate" data-testid="calendar-datepicker">
                    <DatePickerField @bind-Value="_model2.EventDate" Name="eventDate" Required="true" class="datepicker-field" data-testid="calendar-field">
                        <DatePickerLabel class="sr-only">Event Date</DatePickerLabel>
                        <DatePickerInput class="datepicker-segments" data-testid="calendar-input" />
                        <DatePickerTrigger class="datepicker-trigger" data-testid="calendar-trigger">
                            <span>Open</span>
                        </DatePickerTrigger>
                    </DatePickerField>
                    <DatePickerPortal>
                        <DatePickerContent class="datepicker-content" data-testid="calendar-content">
                            <DatePickerCalendar @bind-Value="_model2.EventDate" Context="cal" data-testid="calendar-calendar">
                                <DatePickerCalendarHeader class="calendar-header">
                                    <DatePickerCalendarPrevButton class="calendar-nav-button">Prev</DatePickerCalendarPrevButton>
                                    <DatePickerCalendarHeading class="calendar-heading" />
                                    <DatePickerCalendarNextButton class="calendar-nav-button">Next</DatePickerCalendarNextButton>
                                </DatePickerCalendarHeader>
                                <DatePickerCalendarGrid class="calendar-grid">
                                    <DatePickerCalendarGridHead>
                                        <DatePickerCalendarGridRow>
                                            @for (int i = 0; i < cal.Weekdays.Length; i++)
                                            {
                                                var idx = i;
                                                <DatePickerCalendarHeadCell Abbreviation="@cal.WeekdaysLong[idx]" class="calendar-head-cell">
                                                    @cal.Weekdays[idx]
                                                </DatePickerCalendarHeadCell>
                                            }
                                        </DatePickerCalendarGridRow>
                                    </DatePickerCalendarGridHead>
                                    <DatePickerCalendarGridBody>
                                        @foreach (var week in cal.CurrentMonth.Weeks)
                                        {
                                            <DatePickerCalendarGridRow>
                                                @foreach (var date in week)
                                                {
                                                    <DatePickerCalendarCell Date="@date" Context="cellCtx">
                                                        <DatePickerCalendarDay class="calendar-day" />
                                                    </DatePickerCalendarCell>
                                                }
                                            </DatePickerCalendarGridRow>
                                        }
                                    </DatePickerCalendarGridBody>
                                </DatePickerCalendarGrid>
                            </DatePickerCalendar>
                        </DatePickerContent>
                    </DatePickerPortal>
                </DatePickerRoot>
                <ValidationMessage For="() => _model2.EventDate" class="validation-error" data-testid="calendar-validation" />
                <p data-testid="calendar-value">Value: @(_model2.EventDate?.ToString("yyyy-MM-dd") ?? "None")</p>
            </div>

            <button type="submit" data-testid="calendar-submit">Submit</button>
            
            @if (_submitted2)
            {
                <p data-testid="calendar-success" style="color: green;">Form submitted successfully!</p>
            }
        </EditForm>
    </div>

    <div class="test-section" data-testid="minmax-section">
        <h2>Min/Max Validation</h2>
        <EditForm EditContext="_editContext3" OnValidSubmit="HandleValidSubmit3">
            <DataAnnotationsValidator />
            
            <div class="field-container">
                <label>Appointment Date (Min: today, Max: +30 days)</label>
                <DatePickerRoot @bind-Value="_model3.AppointmentDate" data-testid="minmax-datepicker">
                    <DatePickerField @bind-Value="_model3.AppointmentDate" Name="appointmentDate" MinValue="@_minDate" MaxValue="@_maxDate" class="datepicker-field" data-testid="minmax-field">
                        <DatePickerLabel class="sr-only">Appointment Date</DatePickerLabel>
                        <DatePickerInput class="datepicker-segments" data-testid="minmax-input" />
                        <DatePickerTrigger class="datepicker-trigger" data-testid="minmax-trigger">
                            <span>Open</span>
                        </DatePickerTrigger>
                    </DatePickerField>
                    <DatePickerPortal>
                        <DatePickerContent class="datepicker-content" data-testid="minmax-content">
                            <DatePickerCalendar @bind-Value="_model3.AppointmentDate" MinValue="@_minDate" MaxValue="@_maxDate" Context="cal">
                                <DatePickerCalendarHeader class="calendar-header">
                                    <DatePickerCalendarPrevButton class="calendar-nav-button">Prev</DatePickerCalendarPrevButton>
                                    <DatePickerCalendarHeading class="calendar-heading" />
                                    <DatePickerCalendarNextButton class="calendar-nav-button">Next</DatePickerCalendarNextButton>
                                </DatePickerCalendarHeader>
                                <DatePickerCalendarGrid class="calendar-grid">
                                    <DatePickerCalendarGridHead>
                                        <DatePickerCalendarGridRow>
                                            @for (int i = 0; i < cal.Weekdays.Length; i++)
                                            {
                                                var idx = i;
                                                <DatePickerCalendarHeadCell Abbreviation="@cal.WeekdaysLong[idx]" class="calendar-head-cell">
                                                    @cal.Weekdays[idx]
                                                </DatePickerCalendarHeadCell>
                                            }
                                        </DatePickerCalendarGridRow>
                                    </DatePickerCalendarGridHead>
                                    <DatePickerCalendarGridBody>
                                        @foreach (var week in cal.CurrentMonth.Weeks)
                                        {
                                            <DatePickerCalendarGridRow>
                                                @foreach (var date in week)
                                                {
                                                    <DatePickerCalendarCell Date="@date" Context="cellCtx">
                                                        <DatePickerCalendarDay class="calendar-day" />
                                                    </DatePickerCalendarCell>
                                                }
                                            </DatePickerCalendarGridRow>
                                        }
                                    </DatePickerCalendarGridBody>
                                </DatePickerCalendarGrid>
                            </DatePickerCalendar>
                        </DatePickerContent>
                    </DatePickerPortal>
                </DatePickerRoot>
                <p data-testid="minmax-value">Value: @(_model3.AppointmentDate?.ToString("yyyy-MM-dd") ?? "None")</p>
                <p>Min: @_minDate.ToString("yyyy-MM-dd"), Max: @_maxDate.ToString("yyyy-MM-dd")</p>
            </div>

            <button type="submit" data-testid="minmax-submit">Submit</button>
            
            @if (_submitted3)
            {
                <p data-testid="minmax-success" style="color: green;">Form submitted successfully!</p>
            }
        </EditForm>
    </div>
</div>
}

<style>
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .test-section {
        margin-bottom: 2rem;
        padding: 1rem;
        border: 1px solid #eee;
    }

    .field-container {
        margin-bottom: 1rem;
    }

    .datepicker-field {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
    }

    .datepicker-field:focus-within {
        border-color: #0078d4;
        outline: 2px solid rgba(0, 120, 212, 0.3);
    }

    .datepicker-field[data-invalid] {
        border-color: red;
    }

    .datepicker-segments {
        display: flex;
        gap: 0;
    }

    .datepicker-trigger {
        padding: 0.25rem 0.5rem;
        border: none;
        background: #f0f0f0;
        cursor: pointer;
        border-radius: 2px;
    }

    .datepicker-trigger:hover:not(:disabled) {
        background: #e0e0e0;
    }

    .datepicker-content {
        padding: 1rem;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .calendar-heading {
        font-weight: 600;
    }

    .calendar-nav-button {
        padding: 0.25rem 0.5rem;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }

    .calendar-nav-button:hover:not(:disabled) {
        background: #f0f0f0;
    }

    .calendar-grid {
        border-collapse: collapse;
    }

    .calendar-head-cell {
        padding: 0.5rem;
        text-align: center;
        font-weight: 500;
        color: #666;
    }

    .calendar-day {
        width: 2.5rem;
        height: 2.5rem;
        border: none;
        background: transparent;
        cursor: pointer;
        border-radius: 50%;
    }

    .calendar-day:hover:not(:disabled) {
        background: #f0f0f0;
    }

    .calendar-day[data-state="selected"] {
        background: #0078d4;
        color: white;
    }

    .calendar-day[data-today] {
        font-weight: bold;
        color: #0078d4;
    }

    .calendar-day[data-outside-month] {
        color: #ccc;
    }

    .calendar-day:disabled {
        color: #ccc;
        cursor: not-allowed;
    }

    .validation-error {
        color: red;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>

@code {
    // Section 1: Basic EditForm
    private FormModel _model = new();
    private EditContext? _editContext;
    private bool _submitted;

    // Section 2: Calendar Selection
    private FormModel2 _model2 = new();
    private EditContext? _editContext2;
    private bool _submitted2;

    // Section 3: Min/Max
    private FormModel3 _model3 = new();
    private EditContext? _editContext3;
    private bool _submitted3;
    private DateOnly _minDate = DateOnly.FromDateTime(DateTime.Today);
    private DateOnly _maxDate = DateOnly.FromDateTime(DateTime.Today.AddDays(30));

    protected override void OnInitialized()
    {
        _editContext = new(_model);
        _editContext2 = new(_model2);
        _editContext3 = new(_model3);
    }

    private void HandleValidSubmit()
    {
        _submitted = true;
    }

    private void HandleValidSubmit2()
    {
        _submitted2 = true;
    }

    private void HandleValidSubmit3()
    {
        _submitted3 = true;
    }

    public class FormModel
    {
        [Required(ErrorMessage = "Birth date is required")]
        public DateOnly? BirthDate { get; set; }
    }

    public class FormModel2
    {
        [Required(ErrorMessage = "Event date is required")]
        public DateOnly? EventDate { get; set; }
    }

    public class FormModel3
    {
        public DateOnly? AppointmentDate { get; set; }
    }
}
