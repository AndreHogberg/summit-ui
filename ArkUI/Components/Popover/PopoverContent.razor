@namespace ArkUI.Components.Popover
@using ArkUI.Components.Utilities
@using Microsoft.AspNetCore.Components.Rendering

@{
    BuildElement(__builder);
}

@code {
    private void BuildElement(RenderTreeBuilder builder)
    {
        builder.OpenElement(0, As);
        builder.AddAttribute(1, "id", Context.PopoverId);
        builder.AddAttribute(2, "role", "dialog");
        builder.AddAttribute(3, "aria-modal", TrapFocus.ToString().ToLowerInvariant());
        builder.AddAttribute(4, "data-state", DataState);
        builder.AddAttribute(5, "data-side", Side.ToString().ToLowerInvariant());
        builder.AddAttribute(6, "data-align", Align.ToString().ToLowerInvariant());
        builder.AddAttribute(7, "data-ark-popover-content", true);
        builder.AddAttribute(8, "tabindex", "-1");
        // Use visibility: hidden initially to prevent flash in top-left corner before JS positioning
        // JS will set visibility: visible after first position calculation
        builder.AddAttribute(9, "style", "position: absolute; top: 0; left: 0; visibility: hidden;");
        builder.AddMultipleAttributes(10, AdditionalAttributes);
        builder.AddElementReferenceCapture(11, (elementRef) => { _elementRef = elementRef; });
        
        // Wrap content in FocusTrap if enabled
        if (TrapFocus)
        {
            builder.OpenComponent<FocusTrap>(12);
            builder.AddAttribute(13, "IsActive", Context.IsOpen);
            builder.AddAttribute(14, "AutoFocus", true);
            builder.AddAttribute(15, "ReturnFocus", true);
            builder.AddAttribute(16, "ChildContent", (RenderFragment)(childBuilder => childBuilder.AddContent(0, ChildContent)));
            builder.CloseComponent();
        }
        else
        {
            builder.AddContent(12, ChildContent);
        }
        
        builder.CloseElement();
    }
}
